import{e as s,i as y,d as p,iC as E,j1 as S,s as U,r as c,j2 as $,E as A,fN as G,ai as M,iS as V,aq as F}from"./main.bf5b0f8f.js";import{t as H}from"./BitmapContainer.c91ec57e.js";import{l as T,u as L}from"./LayerView.8a096038.js";import{t as R,i as D}from"./BaseGraphicContainer.5a13fc39.js";import{I as N}from"./Utils.36bd6d05.js";import{S as j}from"./ExportStrategy.0faa9088.js";import{s as O,a as Q}from"./drapedUtils.c607c580.js";import{t as k,d as z}from"./popupUtils.36f715df.js";import{i as W}from"./RefreshableLayerView.90973d33.js";import"./WGLContainer.6d42a904.js";import"./definitions.21e97413.js";import"./VertexArrayObject.a53c7e98.js";import"./Texture.4cb5574f.js";import"./ShaderCompiler.fb93483e.js";import"./config.2a39d8a4.js";import"./GeometryUtils.ea8c8742.js";import"./MaterialKey.4b56782e.js";import"./Container.cb2e4c32.js";import"./earcut.f20dd8d8.js";import"./CIMSymbolHelper.f6d4d553.js";import"./BidiEngine.aae60613.js";import"./GeometryUtils.d4e26b77.js";import"./projectionSupport.9905338d.js";import"./json.2d0d6862.js";import"./FeatureContainer.73698a2e.js";import"./TileContainer.b4e8ee81.js";import"./visualVariablesUtils.bc75d0a2.js";import"./visualVariablesUtils.b08bb171.js";import"./Matcher.e397da93.js";import"./tileUtils.77db4829.js";import"./TileClipper.0680b144.js";import"./cimSymbolUtils.6a3c4163.js";import"./quantizationUtils.bc19cee8.js";import"./devEnvironmentUtils.444b8fd1.js";import"./schemaUtils.ae3e82b0.js";import"./MD5.f9440c6b.js";import"./util.29bcb227.js";import"./ComputedAttributeStorage.53df2f64.js";import"./FeatureSetReader.2dc4f8e7.js";import"./centroid.dea55bc3.js";import"./vec3f32.9cc42d31.js";import"./Bitmap.b437d555.js";let g=class extends R{renderChildren(e){if(e.drawPhase!==N.HIGHLIGHT||(this.attributeView.bindTextures(e.context),!this.children.some(a=>a.hasData)))return;super.renderChildren(e);const{painter:r}=e,t=r.effects.highlight;t.bind(e),e.context.setColorMask(!0,!0,!0,!0),e.context.clear(16384),this._renderChildren(e,t.defines.concat(["highlightAll"])),t.draw(e),t.unbind()}};g=s([y("esri.views.2d.layers.support.HighlightGraphicContainer")],g);const B=g,J=e=>{let r=class extends e{initialize(){this.exportImageParameters=new S({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,a){const{layer:m}=this;if(!t)return Promise.reject(new U("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:m}));const l=this.get("view.scale"),f=[],w=async i=>{const n=i.minScale===0||l<=i.minScale,o=i.maxScale===0||l>=i.maxScale;if(i.visible&&n&&o){if(i.sublayers)i.sublayers.forEach(w);else if(i.popupEnabled){const d=z(i,{...a,defaultPopupTemplateEnabled:!1});c(d)&&f.unshift({sublayer:i,popupTemplate:d})}}},P=m.sublayers.toArray().reverse().map(w);await Promise.all(P);const q=f.map(async({sublayer:i,popupTemplate:n})=>{await i.load().catch(()=>{});const o=i.createQuery(),d=c(a)?a.event:null,v=O({renderer:i.renderer,event:d}),x=this.createFetchPopupFeaturesQueryGeometry(t,v);if(o.geometry=x,o.outFields=await k(i,n),this.layer.type==="map-image"&&"floors"in this.view){var I,b;const _=(I=this.view)==null||(b=I.floors)==null?void 0:b.clone(),u=$(_,i);c(u)&&(o.where=o.where?`(${o.where}) AND (${u})`:u)}const C=await this._loadArcadeModules(n);return C&&C.arcadeUtils.hasGeometryOperations(n)||(o.maxAllowableOffset=x.width/v),(await i.queryFeatures(o)).features});return(await A(q)).reduce((i,n)=>n.value?[...i,...n.value]:i,[]).filter(i=>i!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(a=>a.type==="expression"))return G()}};return s([p()],r.prototype,"exportImageParameters",void 0),s([p({readOnly:!0})],r.prototype,"exportImageVersion",null),s([p()],r.prototype,"layer",void 0),s([p()],r.prototype,"suspended",void 0),s([p(E)],r.prototype,"timeExtent",void 0),r=s([y("esri.views.layers.MapImageLayerView")],r),r},K=M.getLogger("esri.views.2d.layers.MapImageLayerView2D");let h=class extends J(W(T(L))){constructor(){super(...arguments),this._highlightGraphics=new V}update(e){this.strategy.update(e).catch(r=>{F(r)||K.error(r)})}attach(){const{imageMaxWidth:e,imageMaxHeight:r,version:t}=this.layer,a=t>=10.3,m=t>=10;this._bitmapContainer=new H,this.container.addChild(this._bitmapContainer);const l=new D({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new B(this.view.featuresTilingScheme)});this.container.addChild(l.container),this.strategy=new j({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:r,imageRotationSupported:a,imageNormalizationSupported:m,hidpi:!0}),this.handles.add(this.watch("exportImageVersion",()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(this.watch("view.floors",()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,r){return this._highlightGraphics.add(e),{remove:()=>{this._highlightGraphics.remove(e)}}}createFetchPopupFeaturesQueryGeometry(e,r){return Q(e,r,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,r,t,a){return this.layer.fetchImage(e,r,t,{timeExtent:this.timeExtent,floors:this.view.floors,...a})}};s([p()],h.prototype,"strategy",void 0),s([p()],h.prototype,"updating",void 0),h=s([y("esri.views.2d.layers.MapImageLayerView2D")],h);const Re=h;export{Re as default};
