import{j0 as m,fv as f,eT as u,j1 as y,iL as p,j2 as c,fG as l,j3 as n,eZ as g}from"./main.4ab5ab2a.js";import{A as F}from"./attrib-layer.37ab7040.js";import"./common-layer.d1f2908b.js";class S extends F{tooltipField;constructor(e,t){super(e,t),this.dataFormat=m.ESRI_FEATURE,this.tooltipField="",this.supportsIdentify=!0,this.layerType=f.FEATURE}async initiate(){u(this.esriLayer=new y(this.makeEsriLayerConfig(this.origRampConfig))),await super.initiate()}makeEsriLayerConfig(e){const t=super.makeEsriLayerConfig(e);return e.initialFilteredQuery&&(t.definitionExpression=e.initialFilteredQuery),t}onLoadActions(){const e=super.onLoadActions(),t=this.esriLayer&&this.origRampConfig.customRenderer?.type;t&&(this.esriLayer.renderer=p(this.config.customRenderer));const i=this.esriLayer.parsedUrl.path,a=this.$iApi.geo.shared.parseUrlIndex(i).index||0;this.serviceUrl=i,this.layerTree.name=this.name,this.layerTree.layerIdx=a;const o=this.loadLayerMetadata(t?{customRenderer:this.esriLayer?.renderer}:{}).then(()=>{if(!this.attLoader)throw new Error("layer metadata loader did not create attribute loader");this.nameField=this.origRampConfig.nameField||this.nameField||"",this.tooltipField=this.origRampConfig.tooltipField||this.nameField,this.processFieldMetadata(this.origRampConfig.fieldMetadata),this.attLoader.updateFieldList(this.fieldList)}),s=this.loadFeatureCount();return e.push(o,s),e}runIdentify(e){if(!this.isValidState||!this.visibility||!this.identify||this.scaleSet.isOffScale(this.$iApi.geo.map.getScale()).offScale)return[];const t=new c,i=l({items:[],loading:t.getPromise(),loaded:!1,uid:this.uid,requestTime:Date.now()}),r={outFields:this.fieldList,includeGeometry:!1};return this.geomType!==n.POLYGON&&e.geometry.type===n.POINT?r.filterGeometry=this.$iApi.geo.query.makeClickBuffer(e.geometry,e.tolerance):r.filterGeometry=e.geometry,r.filterSql=this.getCombinedSqlFilter(),this.queryFeaturesDiscrete(r).then(a=>{a.forEach(o=>{const s=l({data:void 0,format:g.ESRI,loaded:!1,loading:new Promise(d=>{o.graphic.then(h=>{s.data=h.attributes,s.loaded=!0,d()})})});i.items.push(s)}),i.loaded=!0,t.resolveMe()}),[i]}applySqlFilter(e=[]){if(!this.esriLayer){this.noLayerErr();return}const t=this.filter.getCombinedSql(e);this.esriLayer.definitionExpression=t}}export{S as default};
