import{fv as d,j0 as S,eT as L,jf as v,j6 as I,iL as x,C as T,j3 as c,j2 as A,fG as f,eZ as w,fw as R,j8 as G,jc as p,eS as m}from"./main.1c7a89ed.js";import{A as b}from"./attrib-layer.eaea9bcb.js";import"./common-layer.986c3212.js";class M extends b{tooltipField;constructor(r,t,n,l=0){if(super(r,t),this.layerType=d.SUBLAYER,this.isSublayer=!0,this.layerIdx=l,this.parentLayer=n,this.id=`${n.id}-${l}`,this.dataFormat=S.ESRI_FEATURE,this.tooltipField="",this.hovertips=!1,!n.esriLayer)throw new Error("Map Image Layer with no internal esri layer encountered in sublayer creation");this.fetchEsriSublayer(n)}fetchEsriSublayer(r){if(!r.esriLayer){console.error("Attempted to fetch the ESRI sublayer when parent has no ESRI layer");return}this.esriSubLayer=L(r.esriLayer.allSublayers.find(t=>t.id===this.layerIdx))}onLoadActions(){return this.layerTree.name=this.name,this.layerTree.layerIdx=this.layerIdx,this.identify=this.config.state.identify!=null?this.config.state.identify:this.supportsIdentify,[]}async initiate(){this.initialized=!0}async reload(){if(!this.$iApi.geo.map.esriMap){console.error("Attempted layer reload when no map exists");return}this.parentLayer?.reload()}get visibility(){return!this.parentLayer?.esriLayer||!this.esriSubLayer?(this.noLayerErr(),!1):this.esriSubLayer.visible}set visibility(r){if(!this.parentLayer?.esriLayer||!this.esriSubLayer){this.noLayerErr();return}this.esriSubLayer.visible=r}get opacity(){return!this.parentLayer?.esriLayer||!this.esriSubLayer?(this.noLayerErr(),0):this.esriSubLayer.opacity}set opacity(r){if(!this.parentLayer?.esriLayer||!this.esriSubLayer){this.noLayerErr();return}this.parentLayer.isDynamic||console.warn(`Opacity of a Map Image Sublayer was set. The service does not support sublayer opacity. LayerId ${this.id}`),this.esriSubLayer.opacity=r}get clickTolerance(){return!this.parentLayer?.esriLayer||!this.esriSubLayer?(this.noLayerErr(),0):this.parentLayer.clickTolerance}set clickTolerance(r){if(!this.parentLayer?.esriLayer||!this.esriSubLayer){this.noLayerErr();return}this.parentLayer.clickTolerance=r}applySqlFilter(r=[]){if(!this.parentLayer?.esriLayer||!this.esriSubLayer){this.noLayerErr();return}const t=this.filter.getCombinedSql(r);this.esriSubLayer.definitionExpression=t}}class k extends b{isDynamic;constructor(r,t){super(r,t),this.supportsIdentify=!0,this.supportsSublayers=!0,this.layerType=d.MAPIMAGE,this.isDynamic=!1,this.hovertips=!1,this.layerTree.isLayer=!1,this.layerTree.layerIdx=-1}async initiate(){this.esriLayer=L(new v(this.makeEsriLayerConfig(this.origRampConfig))),await super.initiate()}makeEsriLayerConfig(r){const t=super.makeEsriLayerConfig(r);return t.visible=!1,t}onLoadActions(){const r=super.onLoadActions();if(!this.esriLayer)return this.noLayerErr(),r;this.layerTree.name=this.name,this.isLayerLoaded().then(()=>{this.origRampConfig&&this.origRampConfig.state&&(this.visibility=!!this.origRampConfig.state.visibility)}),this.isDynamic=this.esriLayer.capabilities.exportMap.supportsDynamicLayers,this.extent=I.fromESRI(this.esriLayer.fullExtent,this.id+"_extent");const t=e=>{const s=this.esriLayer?.allSublayers.find(i=>i.id===e);if(!s)throw new Error("attempt to find map image sublayer failed");return s},n={};this.origRampConfig.layerEntries.forEach(e=>{n[e.index||0]=e});const l=[],h=(e,s)=>{const i=e.id,y=n[i];if(e.sublayers&&e.sublayers.length>0){const a=(y?y.name:"")||e.title||"",o=new p(i,"",a,!1);s.children.push(o),e.sublayers.forEach(u=>{h(u,o)})}else{this._sublayers[i]||(this._sublayers[i]=new M({layerType:d.SUBLAYER,state:n[i]?.state??{opacity:this.opacity,visibility:this.visibility,hovertips:this.hovertips,identify:this.identify},controls:n[i]?.controls,disabledControls:n[i]?.disabledControls},this.$iApi,this,i));let a=this._sublayers[i];if(a.isRemoved)return;const o=(y?y.name:"")||e.title||"";if(a.name=o,l.push(a),!s.children.map(u=>u.layerIdx).includes(i)||!a.initialized){const u=new p(i,a.uid,a.name,!0);s.children.push(u)}a.esriWatches.push(e.watch("visible",()=>{this.$iApi.event.emit(m.LAYER_VISIBILITYCHANGE,{visibility:a.visibility,uid:a.uid}),a.parentLayer?.checkVisibility()}),e.watch("opacity",u=>{this.$iApi.event.emit(m.LAYER_OPACITYCHANGE,{opacity:u,uid:a.uid})}))}};if(this.origRampConfig.layerEntries.forEach(e=>{if(!e.stateOnly){const s=t(e.index||0);h(s,this.layerTree)}}),l.forEach(e=>{const s=t(e.layerIdx),i=n[e.layerIdx];e.serviceUrl=s.url,e.fetchEsriSublayer(this);const y=e.esriSubLayer&&i?.customRenderer?.type;y&&(e.esriSubLayer.renderer=x(i.customRenderer));const a=e.loadLayerMetadata(y?{customRenderer:e.esriSubLayer?.renderer}:{}).then(()=>{const o=n[e.layerIdx];if(o?(e.visibility=o.state?.visibility||!0,e.opacity=o.state?.opacity||1,e.nameField=o.nameField||e.nameField||"",e.processFieldMetadata(o.fieldMetadata)):e.processFieldMetadata(),e.supportsFeatures){if(!e.attLoader)throw new Error("Map Image Sublayer - expected attLoader to exist");return e.attLoader.updateFieldList(e.fieldList),e.loadFeatureCount()}else return Promise.resolve()});r.push(a)}),this.esriLayer.allSublayers.forEach(e=>{!e.sublayers&&!l.find(s=>s.layerIdx===e.id)&&(e.visible=!1,e.opacity=0)}),!this.name){const s=T(this.esriLayer.url,{query:{f:"json"}}).then(i=>{i.data?(this.name=i.data.mapName||"",this.layerTree.name=this.name):(this.name="[server error]",this.layerTree.name="[server error]",console.error(`Get map name service failed: ${this.esriLayer.url}`))});r.push(s)}return r}runIdentify(r){if(!this.isValidState||!this.visibility)return[];const t=this.$iApi.geo.map;r.sublayerIds&&(r.sublayerIds=r.sublayerIds.map(e=>typeof e=="number"?this.layerTree?.findChildByIdx(e)?.uid:e));const n=r.sublayerIds?this._sublayers.filter(e=>r.sublayerIds?.includes(e.uid)):this._sublayers.filter(e=>e.visibility&&e.supportsFeatures&&e.identify&&!e.scaleSet.isOffScale(t.getScale()).offScale);if(n.length===0)return[];const l={includeGeometry:r.returnGeometry};let h;return r.geometry.type===c.POINT&&(h=this.$iApi.geo.query.makeClickBuffer(r.geometry,r.tolerance)),n.map(e=>{const s=new A,i=f({items:[],loading:s.getPromise(),loaded:!1,uid:e.uid,requestTime:Date.now()});return e.geomType!==c.POLYGON&&h?l.filterGeometry=h:l.filterGeometry=r.geometry,l.outFields=e.fieldList,l.filterSql=e.getCombinedSqlFilter(),e.queryFeaturesDiscrete(l).then(y=>{y.forEach(a=>{const o=f({data:void 0,format:w.ESRI,loaded:!1,loading:new Promise(u=>{a.graphic.then(E=>{o.data=E.attributes,o.loaded=!0,u()})})});i.items.push(o)}),i.loaded=!0,s.resolveMe()}),i})}noFeaturesErr(){console.error("This method targets features and must be called on a Sublayer."),console.trace()}getAttributes(){return this.noFeaturesErr(),Promise.resolve({features:[],oidIndex:{}})}abortAttributeLoad(){this.noFeaturesErr()}destroyAttributes(){this.noFeaturesErr()}getTabularAttributes(){return this.noFeaturesErr(),Promise.resolve({columns:[],rows:[],fields:[],oidField:"error",oidIndex:0})}getGraphic(r,t){return this.noFeaturesErr(),Promise.resolve(new R(new G))}getIcon(r){return this.noFeaturesErr(),Promise.resolve("")}getSqlFilter(r){return this.noFeaturesErr(),""}applySqlFilter(r=[]){this.noFeaturesErr()}getFilterOIDs(r=[],t=void 0){return this.noFeaturesErr(),Promise.resolve(void 0)}}export{k as default};
