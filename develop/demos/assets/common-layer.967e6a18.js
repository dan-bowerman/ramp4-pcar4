import{j9 as h,ja as l,j0 as n,fv as d,jb as i,j2 as r,jc as o,eS as s,fw as u,j8 as c}from"./main.bfcab78f.js";class p extends h{_name;_scaleSet;_legend;_clickTolerance;_featureCount;_fields;_geomType;_nameField;_oidField;_dataFormat;_layerType;_lastFilterUpdate="";origRampConfig;sawLoad;sawRefresh;loadPromise;viewPromise;layerTree;esriWatches;constructor(e,t){super(e,t),this._name=e.name||"",this._scaleSet=new l,this._legend=[],this._featureCount=-1,this._clickTolerance=e.tolerance!=null?e.tolerance:5,this._fields=[],this._geomType="error",this._nameField="error",this._oidField="error",this._dataFormat=n.UNKNOWN,this._layerType=d.UNKNOWN,this.origRampConfig=e,this.id=e.id||"",this.uid=this.$iApi.geo.shared.generateUUID(),this.isRemoved=!1,this.isSublayer=!1,this.supportsIdentify=!1,this.supportsFeatures=!1,this.supportsSublayers=!1,this.isFile=!1,this.initialized=!1,this.sawLoad=!1,this.sawRefresh=!1,this.state=i.LOADING,this.loadPromise=new r,this.viewPromise=new r,this.esriWatches=[],this.layerTree=new o(0,this.uid,this.name,!0)}get initLoadDone(){return this.sawLoad&&this.sawRefresh}noLayerErr(){console.error("Attempted to manipulate the layer before .initiate() finished"),console.trace()}updateState(e){this.state=e,this.$iApi.event.emit(s.LAYER_STATECHANGE,{state:e,uid:this.uid})}async initiate(){if(this.isSublayer)return console.warn("Attempted to initiate a sublayer as a CommonLayer"),Promise.resolve();if(!this.esriLayer){this.noLayerErr();return}this.initialized&&console.error(`Encountered layer initialize while already initialized, layer id ${this.id}`),this.esriWatches.push(this.esriLayer.watch("visible",e=>{this.$iApi.event.emit(s.LAYER_VISIBILITYCHANGE,{visibility:e,uid:this.uid})})),this.esriWatches.push(this.esriLayer.watch("opacity",e=>{this.$iApi.event.emit(s.LAYER_OPACITYCHANGE,{opacity:e,uid:this.uid})})),this.esriWatches.push(this.esriLayer.watch("loadStatus",e=>{const t={"not-loaded":i.LOADING,loading:i.LOADING,loaded:i.LOADED,failed:i.ERROR};e==="loaded"?this.onLoad():this.updateState(t[e])})),this.esriLayer.on("layerview-create",e=>{this.esriView=e.layerView,this.esriWatches.push(e.layerView.watch("updating",t=>{this.updateState(t?i.REFRESH:i.LOADED),t&&(this.sawRefresh=!0)})),this.viewPromise.resolveMe()}),this.initialized=!0,this.sublayers.forEach(e=>e.initiate())}async terminate(){this.sublayers.forEach(e=>e.terminate()),this.loadPromise=new r,this.viewPromise=new r,this.esriWatches.forEach(e=>e.remove()),this.esriWatches=[],this.updateState(i.NEW),this.initialized=!1}async reload(){if(!this.$iApi.geo.map.esriMap){console.error("Attempted layer reload when no map exists");return}let e=0;if(this.initialized){if(this.esriLayer){const t=this.$iApi.geo.map.esriMap.layers.findIndex(a=>a.id===this.id);t>-1&&(e=t,this.$iApi.geo.map.esriMap.layers.remove(this.esriLayer))}this.$iApi.event.emit(s.LAYER_RELOAD_START,this),this.sublayers.forEach(t=>this.$iApi.event.emit(s.LAYER_RELOAD_START,t)),await this.terminate()}if(await this.initiate(),!this.esriLayer){console.error("ESRI layer failed to re-create during reload.");return}this.$iApi.geo.map.esriMap.layers.add(this.esriLayer,e),this.$iApi.event.emit(s.LAYER_RELOAD_END,this),this.sublayers.forEach(t=>this.$iApi.event.emit(s.LAYER_RELOAD_END,t))}makeEsriLayerConfig(e){const t={id:e.id,url:e.url,opacity:e?.state?.opacity??1,visible:e?.state?.visibility??!0};return typeof e.refreshInterval<"u"&&(t.refreshInterval=e.refreshInterval),t}onLoad(){const e=this.onLoadActions();Promise.all(e).then(()=>{this.updateState(i.LOADED),this.sawLoad=!0,this.loadPromise.resolveMe(),this.sublayers.forEach(t=>t?.onLoad&&t?.onLoad())})}onLoadActions(){return this._name||(this._name=this.esriLayer?.title||this.id),this.identify=this.config.state?.identify!=null?this.config.state.identify:this.supportsIdentify,[this.$iApi.geo.proj.checkProj(this.esriLayer.spatialReference).then(t=>t?Promise.resolve():(this.updateState(i.ERROR),Promise.reject()))]}isLayerLoaded(){return this.loadPromise.getPromise()}get isValidState(){return this.state===i.LOADED||this.state===i.REFRESH}mapCheck(){}get name(){return this._name}set name(e){this._name=e}get scaleSet(){return this._scaleSet}set scaleSet(e){this._scaleSet=e}isOffscale(e=void 0){let t;return typeof e>"u"?(this.mapCheck(),t=this.$iApi.geo.map.getScale()):t=e,this.scaleSet.isOffScale(t).offScale}zoomToVisibleScale(){return this.mapCheck(),this.$iApi.geo.map.zoomToVisibleScale(this.scaleSet)}zoomToLayerBoundary(){if(!this.extent)throw new Error(`Attempted to zoom to boundary of a layer with no extent (Layer Id: ${this.id})`);return this.mapCheck(),this.$iApi.geo.map.zoomMapTo(this.extent)}get legend(){return this._legend}set legend(e){this._legend=e}get featureCount(){return this._featureCount}set featureCount(e){this._featureCount=e}get clickTolerance(){return this._clickTolerance}set clickTolerance(e){if(!this.supportsIdentify){console.warn("Attempted to set click tolerance on a layer that doesn't support identify");return}if(e<0){console.error("Attempted to set a negative click tolerance");return}this._clickTolerance=e}get fields(){return this._fields}set fields(e){this._fields=e}get geomType(){return this._geomType}set geomType(e){this._geomType=e}get nameField(){return this._nameField}set nameField(e){this._nameField=e}get oidField(){return this._oidField}set oidField(e){this._oidField=e}get dataFormat(){return this._dataFormat}set dataFormat(e){this._dataFormat=e}get layerType(){return this._layerType}set layerType(e){this._layerType=e}getLayerTree(){return this.layerTree?this.layerTree:(this.noLayerErr(),new o(0,"YOU DID AN ERROR","Error, check your console pls"))}get visibility(){return this.esriLayer?this.esriLayer.visible:(this.noLayerErr(),!1)}set visibility(e){this.esriLayer?this.esriLayer.visible=e:this.noLayerErr()}checkVisibility(){this.supportsSublayers&&(this.visibility=this.sublayers.some(e=>e.visibility))}get opacity(){return this.esriLayer?this.esriLayer.opacity:(this.noLayerErr(),0)}set opacity(e){this.esriLayer?this.esriLayer.opacity=e:this.noLayerErr()}stubError(){throw new Error(`Attempted to use a method not valid for ${this._layerType}`)}getAttributes(){return this.stubError(),Promise.resolve({features:[],oidIndex:{}})}abortAttributeLoad(){this.stubError()}destroyAttributes(){this.stubError()}getTabularAttributes(){return this.stubError(),Promise.resolve({columns:[],rows:[],fields:[],oidField:"error",oidIndex:0})}getGraphic(e,t){return this.stubError(),Promise.resolve(new u(new c))}getIcon(e){return this.stubError(),Promise.resolve("")}getSqlFilter(e){return this.stubError(),""}setSqlFilter(e,t){this.stubError()}getFilterOIDs(e=[],t=void 0){return this.stubError(),Promise.resolve(void 0)}applySqlFilter(e=[]){this.stubError()}setCustomParameter(e,t,a=!0){this.stubError()}}export{p as C};
