import{fv as L,j0 as w,eT as b,ji as T,j3 as v,j2 as R,fG as S,eZ as c,C as I,fE as W}from"./main.839c5da4.js";import{C as x}from"./common-layer.7522fccd.js";class A extends x{sublayerNames;mimeType;constructor(r,s){super(r,s),this.supportsIdentify=!0,this.hovertips=!1,this.layerType=L.WMS,this.mimeType=r.featureInfoMimeType||"",this.sublayerNames=[],this.dataFormat=w.OGC_RASTER}async initiate(){this.esriLayer=b(new T(this.makeEsriLayerConfig(this.origRampConfig))),await super.initiate()}makeEsriLayerConfig(r){const s=super.makeEsriLayerConfig(r),i=r.layerEntries;this.sublayerNames=i.map(e=>e.id||"error_no_wms_id");const t=i.map(e=>e.currentStyle).join();return s.customParameters={styles:t},r.url.indexOf("/geomet")!==-1&&(s.customParameters.layers=i[0].id),s}onLoadActions(){const r=super.onLoadActions();this.layerTree.name=this.name;const s=i=>{let t=!1;return i.forEach(e=>{this.sublayerNames.indexOf(e.name)>-1||e.sublayers&&e.sublayers.length>0&&s(e.sublayers)?t=!0:e.visible=!1}),t};return this.esriLayer?s(this.esriLayer.sublayers):this.noLayerErr(),r.push(this.loadSymbology()),r}runIdentify(r){if(r.geometry.type!==v.POINT)throw new Error("a point must be used for WMS Identify");const s=this.$iApi.geo.map;if(!this.isValidState||!this.visibility||!this.identify||this.scaleSet.isOffScale(s.getScale()).offScale)return[];const i=new R,t=S({items:[],loading:i.getPromise(),loaded:!1,uid:this.uid,requestTime:Date.now()});return this.getFeatureInfo(this.sublayerNames,r.geometry,this.mimeType).then(e=>{if(e){const a=S({data:e,format:c.UNKNOWN,loaded:!0,loading:Promise.resolve()});typeof e!="string"?(a.format=c.JSON,t.items.push(a)):e.indexOf("Search returned no results")===-1&&e!==""&&(a.format=c.TEXT,t.items.push(a))}t.loaded=!0,i.resolveMe()}),[t]}setCustomParameter(r,s,i=!0){this.esriLayer?(this.esriLayer.customLayerParameters[r]=s,i&&this.esriLayer.refresh()):this.noLayerErr()}getFeatureInfo(r,s,i){const t=this.$iApi.geo.map,e=this.esriLayer;if(!t.esriView)throw new Error("WMS get feature, no map view exists. Cannot derive click coords");if(!e)throw this.noLayerErr(),new Error("wms get feature failed, no layer");let a,o;const n=t.getExtent(),m=e.spatialReferences,d=r.join(","),h=t.esriView.toScreen(s.toESRI()),g=Math.floor(h.x),p=Math.floor(h.y),E={"application/json":"json"}[i]||"text",y=t.getSR();y.wkid?a=y.wkid:(a=4326,console.error("Map is likely in a WKT projection. WMS Identify request will likely fail.")),m&&m.length>1?m.indexOf(a)===-1&&(y.latestWkid&&m.indexOf(y.latestWkid)>-1?a=y.latestWkid:console.error("WMS service does not support the maps projection. Identify request will likely fail.")):console.error("No supported wkid/epsg code found for WMS service. Identify request will likely fail."),e.version==="1.3"||e.version==="1.3.0"?(o={CRS:"EPSG:"+a,I:g,J:p,STYLES:"",FORMAT:e.imageFormat},this.$iApi.geo.layer.ogc.reversedAxisWKIDs().indexOf(a)>-1&&(o.BBOX=`${n.ymin},${n.xmin},${n.ymax},${n.xmax}`)):o={SRS:"EPSG:"+a,X:g,Y:p},o.hasOwnProperty("BBOX")||(o.BBOX=`${n.xmin},${n.ymin},${n.xmax},${n.ymax}`);const f={SERVICE:"WMS",REQUEST:"GetFeatureInfo",VERSION:e.version,WIDTH:t.getPixelWidth(),HEIGHT:t.getPixelHeight(),QUERY_LAYERS:d,LAYERS:d,INFO_FORMAT:i},u=e.customLayerParameters;return u&&Object.keys(u).forEach(l=>{l.toLowerCase()!=="styles"&&(f[l]=u[l])}),Object.keys(f).forEach(l=>o[l]=f[l]),I(e.url.split("?")[0],{query:o,responseType:E})}getLegendUrls(r){if(!this.esriLayer)return this.noLayerErr(),[];const s=new Map;this.esriLayer.allSublayers.forEach(t=>{t.visible&&(t.legendUrl&&this.origRampConfig.layerEntries?.forEach(e=>{if(e.id&&e.currentStyle&&e.id===t.name){const a=new W(t.legendUrl);"STYLE"in a.queryMap&&a.queryMap.STYLE!==e.currentStyle&&(t.legendUrl=a.updateQuery({STYLE:e.currentStyle}))}}),s.set(t.name,t.legendUrl))});const i=r.map(t=>t.styleLegends&&t.currentStyle?t.styleLegends.find(e=>e.name===t.currentStyle).url:void 0);return i.forEach((t,e)=>{t||(i[e]=s.get(r[e].id))}),i}getWMSLayerTitle(r){if(!this.esriLayer)return"";let s;return this.esriLayer.allSublayers.some(i=>{if(i.name===r)return s=i.title,!0}),s||""}loadSymbology(){const r=this.config.layerEntries,s=this.getLegendUrls(r.map(i=>({id:i.id,styleLegends:i.styleLegends,currentStyle:i.currentStyle}))).map((i,t)=>{const e=r[t].name||this.getWMSLayerTitle(r[t].id)||r[t].id,a={uid:this.$iApi.geo.shared.generateUUID(),label:e,svgcode:"",esriStandard:!1,drawPromise:this.$iApi.geo.symbology.generateWMSSymbology(i).then(o=>{a.svgcode=o.svgcode,a.imgHeight=o.imgHeight,a.imgWidth=o.imgWidth})};return a});return this.legend=s,Promise.resolve()}}export{A as default};
