import{e_ as v,eR as H,et as y,eu as L,eF as M,ew as _,eG as k,eH as R,eI as O,eA as $,eT as B}from"./main.1c7a89ed.js";import{E,x as D,a as j}from"./screen.013e4dad.js";import{f as F}from"./fabric.4f3540c1.js";var S={exports:{}};(function(d,n){(function(p,c){c()})(v,function(){function p(e,t){return typeof t>"u"?t={autoBom:!1}:typeof t!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\uFEFF",e],{type:e.type}):e}function c(e,t,r){var o=new XMLHttpRequest;o.open("GET",e),o.responseType="blob",o.onload=function(){f(o.response,t,r)},o.onerror=function(){console.error("could not download file")},o.send()}function x(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch{}return 200<=t.status&&299>=t.status}function u(e){try{e.dispatchEvent(new MouseEvent("click"))}catch{var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var a=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof v=="object"&&v.global===v?v:void 0,b=a.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),f=a.saveAs||(typeof window!="object"||window!==a?function(){}:"download"in HTMLAnchorElement.prototype&&!b?function(e,t,r){var o=a.URL||a.webkitURL,i=document.createElement("a");t=t||e.name||"download",i.download=t,i.rel="noopener",typeof e=="string"?(i.href=e,i.origin===location.origin?u(i):x(i.href)?c(e,t,r):u(i,i.target="_blank")):(i.href=o.createObjectURL(e),setTimeout(function(){o.revokeObjectURL(i.href)},4e4),setTimeout(function(){u(i)},0))}:"msSaveOrOpenBlob"in navigator?function(e,t,r){if(t=t||e.name||"download",typeof e!="string")navigator.msSaveOrOpenBlob(p(e,r),t);else if(x(e))c(e,t,r);else{var o=document.createElement("a");o.href=e,o.target="_blank",setTimeout(function(){u(o)})}}:function(e,t,r,o){if(o=o||open("","_blank"),o&&(o.document.title=o.document.body.innerText="downloading..."),typeof e=="string")return c(e,t,r);var i=e.type==="application/octet-stream",l=/constructor/i.test(a.HTMLElement)||a.safari,m=/CriOS\/[\d]+/.test(navigator.userAgent);if((m||i&&l||b)&&typeof FileReader<"u"){var h=new FileReader;h.onloadend=function(){var w=h.result;w=m?w:w.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=w:location=w,o=null},h.readAsDataURL(e)}else{var A=a.URL||a.webkitURL,g=A.createObjectURL(e);o?o.location=g:location.href=g,o=null,setTimeout(function(){A.revokeObjectURL(g)},4e4)}});a.saveAs=f.saveAs=f,d.exports=f})})(S);var N=S.exports;F.fabric.Object.prototype.objectCaching=!1;const T=1200,s={TOP:40,RIGHT:40,BOTTOM:40,LEFT:40};class C extends H{fcFabric;fcFabricDownload;options={runningHeight:0,scale:1};get config(){return super.config}_parseConfig(n){!n||(this.$vApp.$store.set(E.componentSelectedState,{title:n.title?.selected??!0,map:n.map?.selected??!0,mapElements:n.mapElements?.selected??!0,legend:n.legend?.selected??!0,footnote:n.footnote?.selected??!0,timestamp:n.timestamp?.selected??!0}),this.$vApp.$store.set(E.fileName,n.fileName||""))}getSubFixture(n){return this.$iApi.fixture.get(n)}async make(n,p){this.fcFabric=new F.fabric.StaticCanvas(n,{backgroundColor:"#fff"}),this.fcFabricDownload=new F.fabric.StaticCanvas(null,{backgroundColor:"#fff"}),this.options.runningHeight=0;let c=this.$iApi.$vApp.$store.get(E.componentSelectedState);const x=this.getSubFixture("export-title"),u=this.getSubFixture("export-map"),a=this.getSubFixture("export-scalebar"),b=this.getSubFixture("export-northarrow"),f=this.getSubFixture("export-legend");let e,t,r,o,i,l=[];c.title&&(e=await x.make({top:this.options.runningHeight,left:0,originX:"left"}),this.options.runningHeight+=e.height+40,l.push(e)),c.map&&(t=await u.make({top:this.options.runningHeight}),e&&(e.left=t.width/2,e.originX="center"),this.options.runningHeight+=t.height+40,l.push(t)),this.options.scale=p/((t?.width??T)+s.LEFT+s.RIGHT),c.mapElements&&(r=await a.make({top:this.options.runningHeight,left:0}),this.options.runningHeight+=r.height+40,l.push(r),o=await b.make({top:r.top,left:p/this.options.scale}),o.top+=o.height/2-20,o.left+=-o.width*2,l.push(o)),c.legend&&(i=await f.make({width:f.config?.columnWidth??t?.width??T}),i.top=this.options.runningHeight,this.options.runningHeight+=i.height,l.push(i));const m=new F.fabric.Group(l,{top:s.TOP*this.options.scale,left:s.LEFT*this.options.scale}),h=await new Promise(A=>{m.clone(g=>{A(g)})});h.top=s.TOP,h.left=s.LEFT,this.fcFabricDownload.add(h),m.scale(this.options.scale),this.fcFabric.add(m),this.fcFabric.setDimensions({width:p,height:(this.options.runningHeight+s.TOP+s.BOTTOM)*this.options.scale}),this.fcFabric.renderAll(),this.fcFabricDownload.setDimensions({width:(t?.width??T)+s.LEFT+s.RIGHT,height:this.options.runningHeight+s.TOP+s.BOTTOM}),this.fcFabricDownload.renderAll()}export(){if(!this.fcFabric)return;const n=new Date,p=this.config?.fileName||`map-carte - ${n.getFullYear()}-${n.getMonth()}-${n.getDay()}, ${n.getHours()}_${n.getMinutes()}`;N.saveAs(this.fcFabricDownload.toDataURL({format:"png",quality:1}),`${p}.png`)}}const G=y({name:"ExportAppbarButtonV",methods:{onClick(){this.$iApi.panel.toggle("export-panel")}}}),U=$("svg",{class:"fill-current w-24 h-24 ml-8 sm:ml-20",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},[$("path",{d:"M0 0h24v24H0z",fill:"none"}),$("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})],-1);function I(d,n,p,c,x,u){const a=M("appbar-button",!0);return _(),k(a,{onClickFunction:d.onClick,tooltip:d.$t("export.title")},{default:R(()=>[O(" https://fonts.google.com/icons?selected=Material+Icons:layers&icon.query=export "),U]),_:1},8,["onClickFunction","tooltip"])}var P=L(G,[["render",I],["__file","/home/runner/work/ramp4-pcar4/ramp4-pcar4/src/fixtures/export/appbar-button.vue"]]),V={en:{"export.title":"Export","export.alertName":"Export","export.download":"Download image","export.refresh":"Refresh","export.scaleBar.approx":"{0} approx.","export.menu":"Settings Menu","export.menu.component.title":"Title","export.menu.component.map":"Map","export.menu.component.mapElements":"North arrow and scalebar","export.menu.component.legend":"Legend","export.menu.component.footnote":"Footnote","export.menu.component.timestamp":"Timestamp"},fr:{"export.title":"[fr] Export","export.alertName":"[fr] Export","export.download":"[fr] Download image","export.refresh":"[fr] Refresh","export.scaleBar.approx":"[fr] {0} approx.","export.menu":"[fr] Settings Menu","export.menu.component.title":"Titre","export.menu.component.map":"Carte","export.menu.component.mapElements":"Fl\xE8che du nord et \xE9chelle graphique","export.menu.component.legend":"L\xE9gende","export.menu.component.footnote":"R\xE9f\xE9rence","export.menu.component.timestamp":"[fr] Timestamp"}};class K extends C{initialized(){this.$iApi.fixture.add("export-title"),this.$iApi.fixture.add("export-map"),this.$iApi.fixture.add("export-legend"),this.$iApi.fixture.add("export-northarrow"),this.$iApi.fixture.add("export-scalebar")}added(){console.log(`[fixture] ${this.id} added`),this.$iApi.component("export-appbar-button",P),this.$vApp.$store.registerModule("export",D()),this.$iApi.panel.register({id:"export-panel",config:{screens:{"export-screen":B(j)},style:{"flex-grow":"1","max-width":"800px"},alertName:"export.alertName"}},{i18n:{messages:V}}),this._parseConfig(this.config);let n=this.$vApp.$watch(()=>this.config,p=>this._parseConfig(p));this.removed=()=>{console.log(`[fixture] ${this.id} removed`),n(),this.$iApi.fixture.get("export-title")?.remove(),this.$iApi.fixture.get("export-map")?.remove(),this.$iApi.fixture.get("export-legend")?.remove(),this.$iApi.fixture.get("export-northarrow")?.remove(),this.$iApi.fixture.get("export-scalebar")?.remove(),this.$iApi.panel.remove("export-panel"),this.$vApp.$store.unregisterModule("export")}}}export{K as default};
