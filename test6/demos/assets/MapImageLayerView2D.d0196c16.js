import{e as s,i as y,d as p,ix as E,iY as U,s as $,r as c,iZ as A,E as G,fI as M,ag as S,iN as V,ao as F}from"./main.7dbc90fb.js";import{t as H}from"./BitmapContainer.b57acc74.js";import{l as T,u as L}from"./LayerView.fddb0cea.js";import{t as R,i as D}from"./BaseGraphicContainer.d7614727.js";import{I as N}from"./Utils.60a4d83b.js";import{S as O}from"./ExportStrategy.6f733618.js";import{s as Q,a as k}from"./drapedUtils.6582f277.js";import{t as z,d as W}from"./popupUtils.95f26a9a.js";import{i as j}from"./RefreshableLayerView.7b5711ed.js";import"./WGLContainer.b7354ae8.js";import"./definitions.21e97413.js";import"./VertexArrayObject.e4595858.js";import"./Texture.b479c6db.js";import"./ShaderCompiler.9723433c.js";import"./config.2a39d8a4.js";import"./GeometryUtils.ea8c8742.js";import"./MaterialKey.f58cf799.js";import"./Container.734b43bf.js";import"./earcut.f20dd8d8.js";import"./CIMSymbolHelper.786e5dde.js";import"./BidiEngine.aae60613.js";import"./GeometryUtils.d4e26b77.js";import"./projectionSupport.e4d50a24.js";import"./json.2d0d6862.js";import"./FeatureContainer.db3f6a98.js";import"./TileContainer.6b0ce512.js";import"./visualVariablesUtils.85fe540d.js";import"./visualVariablesUtils.37fbde30.js";import"./Matcher.5a1921d5.js";import"./tileUtils.4e4bdc6a.js";import"./TileClipper.2ee1b3ca.js";import"./cimSymbolUtils.7013d9e5.js";import"./quantizationUtils.07b38d8e.js";import"./devEnvironmentUtils.444b8fd1.js";import"./schemaUtils.8627649f.js";import"./MD5.f9440c6b.js";import"./util.e78e8029.js";import"./ComputedAttributeStorage.d51d1cad.js";import"./FeatureSetReader.4e3ef9fc.js";import"./centroid.bebc2751.js";import"./vec3f32.9cc42d31.js";import"./Bitmap.8a39f2c4.js";let g=class extends R{renderChildren(e){if(e.drawPhase!==N.HIGHLIGHT||(this.attributeView.bindTextures(e.context),!this.children.some(a=>a.hasData)))return;super.renderChildren(e);const{painter:r}=e,t=r.effects.highlight;t.bind(e),e.context.setColorMask(!0,!0,!0,!0),e.context.clear(16384),this._renderChildren(e,t.defines.concat(["highlightAll"])),t.draw(e),t.unbind()}};g=s([y("esri.views.2d.layers.support.HighlightGraphicContainer")],g);const Y=g,Z=e=>{let r=class extends e{initialize(){this.exportImageParameters=new U({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,a){const{layer:m}=this;if(!t)return Promise.reject(new $("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:m}));const l=this.get("view.scale"),f=[],w=async i=>{const n=i.minScale===0||l<=i.minScale,o=i.maxScale===0||l>=i.maxScale;if(i.visible&&n&&o){if(i.sublayers)i.sublayers.forEach(w);else if(i.popupEnabled){const d=W(i,{...a,defaultPopupTemplateEnabled:!1});c(d)&&f.unshift({sublayer:i,popupTemplate:d})}}},P=m.sublayers.toArray().reverse().map(w);await Promise.all(P);const _=f.map(async({sublayer:i,popupTemplate:n})=>{await i.load().catch(()=>{});const o=i.createQuery(),d=c(a)?a.event:null,v=Q({renderer:i.renderer,event:d}),x=this.createFetchPopupFeaturesQueryGeometry(t,v);if(o.geometry=x,o.outFields=await z(i,n),this.layer.type==="map-image"&&"floors"in this.view){var I,b;const q=(I=this.view)==null||(b=I.floors)==null?void 0:b.clone(),u=A(q,i);c(u)&&(o.where=o.where?`(${o.where}) AND (${u})`:u)}const C=await this._loadArcadeModules(n);return C&&C.arcadeUtils.hasGeometryOperations(n)||(o.maxAllowableOffset=x.width/v),(await i.queryFeatures(o)).features});return(await G(_)).reduce((i,n)=>n.value?[...i,...n.value]:i,[]).filter(i=>i!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(a=>a.type==="expression"))return M()}};return s([p()],r.prototype,"exportImageParameters",void 0),s([p({readOnly:!0})],r.prototype,"exportImageVersion",null),s([p()],r.prototype,"layer",void 0),s([p()],r.prototype,"suspended",void 0),s([p(E)],r.prototype,"timeExtent",void 0),r=s([y("esri.views.layers.MapImageLayerView")],r),r},B=S.getLogger("esri.views.2d.layers.MapImageLayerView2D");let h=class extends Z(j(T(L))){constructor(){super(...arguments),this._highlightGraphics=new V}update(e){this.strategy.update(e).catch(r=>{F(r)||B.error(r)})}attach(){const{imageMaxWidth:e,imageMaxHeight:r,version:t}=this.layer,a=t>=10.3,m=t>=10;this._bitmapContainer=new H,this.container.addChild(this._bitmapContainer);const l=new D({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new Y(this.view.featuresTilingScheme)});this.container.addChild(l.container),this.strategy=new O({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:r,imageRotationSupported:a,imageNormalizationSupported:m,hidpi:!0}),this.handles.add(this.watch("exportImageVersion",()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(this.watch("view.floors",()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,r){return this._highlightGraphics.add(e),{remove:()=>{this._highlightGraphics.remove(e)}}}createFetchPopupFeaturesQueryGeometry(e,r){return k(e,r,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,r,t,a){return this.layer.fetchImage(e,r,t,{timeExtent:this.timeExtent,floors:this.view.floors,...a})}};s([p()],h.prototype,"strategy",void 0),s([p()],h.prototype,"updating",void 0),h=s([y("esri.views.2d.layers.MapImageLayerView2D")],h);const Re=h;export{Re as default};
