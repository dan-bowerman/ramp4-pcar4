import{e as s,i as y,d as p,iA as q,i$ as A,s as E,r as c,j0 as U,E as G,fL as M,ag as S,iQ as V,ao as F}from"./multi-ramp.54622117.js";import{t as H}from"./BitmapContainer.2b672163.js";import{l as L,u as T}from"./LayerView.1892ecb5.js";import{t as R,i as D}from"./BaseGraphicContainer.7af9e958.js";import{I as Q}from"./Utils.46d885e7.js";import{S as N}from"./ExportStrategy.c9c40c91.js";import{s as O,a as j}from"./drapedUtils.8c8cb6d4.js";import{t as k,d as z}from"./popupUtils.09088845.js";import{i as W}from"./RefreshableLayerView.c6c0f8ff.js";import"./WGLContainer.eb57a9a4.js";import"./definitions.21e97413.js";import"./VertexArrayObject.4fe83f24.js";import"./Texture.f57edcfe.js";import"./ShaderCompiler.6f6ca2fb.js";import"./config.2a39d8a4.js";import"./GeometryUtils.ea8c8742.js";import"./MaterialKey.11930c6b.js";import"./Container.b0419870.js";import"./earcut.f20dd8d8.js";import"./CIMSymbolHelper.8617d551.js";import"./BidiEngine.aae60613.js";import"./GeometryUtils.d4e26b77.js";import"./projectionSupport.d5670350.js";import"./json.2d0d6862.js";import"./FeatureContainer.b5088f51.js";import"./TileContainer.cdc669e2.js";import"./visualVariablesUtils.85e8dcf9.js";import"./visualVariablesUtils.69fcf300.js";import"./Matcher.deda53ad.js";import"./tileUtils.7548e846.js";import"./TileClipper.62c6bf3e.js";import"./cimSymbolUtils.a532fa14.js";import"./quantizationUtils.157ab9d9.js";import"./devEnvironmentUtils.444b8fd1.js";import"./schemaUtils.bf03ae10.js";import"./MD5.f9440c6b.js";import"./util.7b808591.js";import"./ComputedAttributeStorage.3b600b0e.js";import"./FeatureSetReader.4a7f8c4d.js";import"./centroid.7b902fe9.js";import"./vec3f32.9cc42d31.js";import"./Bitmap.a6ae58f1.js";let g=class extends R{renderChildren(e){if(e.drawPhase!==Q.HIGHLIGHT||(this.attributeView.bindTextures(e.context),!this.children.some(a=>a.hasData)))return;super.renderChildren(e);const{painter:r}=e,t=r.effects.highlight;t.bind(e),e.context.setColorMask(!0,!0,!0,!0),e.context.clear(16384),this._renderChildren(e,t.defines.concat(["highlightAll"])),t.draw(e),t.unbind()}};g=s([y("esri.views.2d.layers.support.HighlightGraphicContainer")],g);const B=g,J=e=>{let r=class extends e{initialize(){this.exportImageParameters=new A({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,a){const{layer:m}=this;if(!t)return Promise.reject(new E("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:m}));const l=this.get("view.scale"),f=[],w=async i=>{const n=i.minScale===0||l<=i.minScale,o=i.maxScale===0||l>=i.maxScale;if(i.visible&&n&&o){if(i.sublayers)i.sublayers.forEach(w);else if(i.popupEnabled){const d=z(i,{...a,defaultPopupTemplateEnabled:!1});c(d)&&f.unshift({sublayer:i,popupTemplate:d})}}},P=m.sublayers.toArray().reverse().map(w);await Promise.all(P);const _=f.map(async({sublayer:i,popupTemplate:n})=>{await i.load().catch(()=>{});const o=i.createQuery(),d=c(a)?a.event:null,v=O({renderer:i.renderer,event:d}),x=this.createFetchPopupFeaturesQueryGeometry(t,v);if(o.geometry=x,o.outFields=await k(i,n),this.layer.type==="map-image"&&"floors"in this.view){var I,b;const $=(I=this.view)==null||(b=I.floors)==null?void 0:b.clone(),u=U($,i);c(u)&&(o.where=o.where?`(${o.where}) AND (${u})`:u)}const C=await this._loadArcadeModules(n);return C&&C.arcadeUtils.hasGeometryOperations(n)||(o.maxAllowableOffset=x.width/v),(await i.queryFeatures(o)).features});return(await G(_)).reduce((i,n)=>n.value?[...i,...n.value]:i,[]).filter(i=>i!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(a=>a.type==="expression"))return M()}};return s([p()],r.prototype,"exportImageParameters",void 0),s([p({readOnly:!0})],r.prototype,"exportImageVersion",null),s([p()],r.prototype,"layer",void 0),s([p()],r.prototype,"suspended",void 0),s([p(q)],r.prototype,"timeExtent",void 0),r=s([y("esri.views.layers.MapImageLayerView")],r),r},K=S.getLogger("esri.views.2d.layers.MapImageLayerView2D");let h=class extends J(W(L(T))){constructor(){super(...arguments),this._highlightGraphics=new V}update(e){this.strategy.update(e).catch(r=>{F(r)||K.error(r)})}attach(){const{imageMaxWidth:e,imageMaxHeight:r,version:t}=this.layer,a=t>=10.3,m=t>=10;this._bitmapContainer=new H,this.container.addChild(this._bitmapContainer);const l=new D({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new B(this.view.featuresTilingScheme)});this.container.addChild(l.container),this.strategy=new N({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:r,imageRotationSupported:a,imageNormalizationSupported:m,hidpi:!0}),this.handles.add(this.watch("exportImageVersion",()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(this.watch("view.floors",()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,r){return this._highlightGraphics.add(e),{remove:()=>{this._highlightGraphics.remove(e)}}}createFetchPopupFeaturesQueryGeometry(e,r){return j(e,r,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,r,t,a){return this.layer.fetchImage(e,r,t,{timeExtent:this.timeExtent,floors:this.view.floors,...a})}};s([p()],h.prototype,"strategy",void 0),s([p()],h.prototype,"updating",void 0),h=s([y("esri.views.2d.layers.MapImageLayerView2D")],h);const Re=h;export{Re as default};
